% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/cosero_optimize.R
\name{optimize_cosero_sce}
\alias{optimize_cosero_sce}
\title{Optimize COSERO Parameters with SCE-UA Algorithm}
\usage{
optimize_cosero_sce(
  cosero_path,
  par_bounds,
  target_subbasins = "001",
  zones_to_modify = NULL,
  metric = "NSE",
  metric_weights = NULL,
  subbasin_weights = NULL,
  aggregation = "mean",
  defaults_settings = NULL,
  maxn = 10000,
  kstop = 10,
  pcento = 0.01,
  ngs = 2,
  verbose = TRUE,
  read_final_outputs = TRUE,
  use_minimal_reading = TRUE
)
}
\arguments{
\item{cosero_path}{Character. Path to the COSERO project directory containing
\code{input/} and \code{output/} folders, and \code{COSERO.exe}.}

\item{par_bounds}{Data frame with parameter bounds. Create using
\code{\link{create_optimization_bounds}} for custom bounds or
\code{\link{load_parameter_bounds}} to use package defaults.
Required columns: parameter, min, max, default, modification_type.}

\item{target_subbasins}{Character vector. Subbasin IDs to calibrate for
(e.g., \code{"001"}, \code{c("001", "002")}, or \code{"all"}).
Controls both which zones are modified AND which subbasins are used
for metric calculation. Zone-subbasin mapping requires \code{topology.txt}
in output folder (generated by running COSERO at least once).}

\item{zones_to_modify}{Integer vector or NULL. Specific zone IDs to modify.
If NULL (default), zones are automatically determined from \code{target_subbasins}
using topology.txt. Use this for manual control, e.g., to optimize only
certain elevation bands or land use types.}

\item{metric}{Character vector. Performance metric(s) to optimize.
Options: \code{"NSE"} (default), \code{"KGE"}, \code{"lnNSE"}, \code{"rNSE"},
\code{"RMSE"}, \code{"PBIAS"}, \code{"VE"}.
For multi-objective, provide vector: \code{c("NSE", "KGE")}.}

\item{metric_weights}{Numeric vector or NULL. Weights for combining multiple
metrics (must sum to 1). Required when \code{metric} has length greater than 1.
Example: \code{c(0.6, 0.4)} for 0.6 NSE plus 0.4 KGE.}

\item{subbasin_weights}{Numeric vector or NULL. Weights for aggregating metrics
across subbasins. Required when \code{aggregation = "weighted"}.
Must have same length as \code{target_subbasins} and sum to 1.}

\item{aggregation}{Character. Method to aggregate metrics across multiple subbasins.
Options: \code{"mean"} (default), \code{"weighted"} (requires subbasin_weights),
\code{"min"} (worst subbasin), \code{"product"}.}

\item{defaults_settings}{Named list. COSERO configuration settings including
\code{STARTDATE}, \code{ENDDATE}, \code{SPINUP}, \code{OUTPUTTYPE}, \code{PARAFILE}.}

\item{maxn}{Maximum number of function evaluations}

\item{kstop}{Number of shuffling loops to check convergence}

\item{pcento}{Percentage change for convergence criterion}

\item{ngs}{Number of complexes (sub-populations). Higher values increase global
search capability but slow down convergence.}

\item{verbose}{Logical. If TRUE (default), prints progress bar and messages.}

\item{read_final_outputs}{Logical. If TRUE (default), runs COSERO once more
with optimal parameters and returns full output data.}

\item{use_minimal_reading}{Logical. If TRUE (default), only reads statistics.txt
and COSERO.runoff during optimization for faster I/O.}
}
\value{
A list containing:
\itemize{
\item \code{par}: Numeric vector of optimal parameter values
\item \code{value}: Best objective value (negative of metric, since SCE minimizes)
\item \code{convergence}: Convergence status from SCE-UA
\item \code{par_bounds}: Input par_bounds with added \code{optimal_value} column
\item \code{runtime_seconds}: Total optimization time in seconds
\item \code{final_run}: COSERO run result with optimal parameters (if read_final_outputs=TRUE)
\item \code{optimized_par_file}: Path to the saved optimized parameter file
\item \code{target_subbasins}: Subbasins used for calibration
\item \code{zones_to_modify}: Zone IDs that were modified
\item \code{metric}: Metric(s) used
\item \code{algorithm}: "SCE-UA"
}
}
\description{
Shuffled Complex Evolution (SCE-UA) optimization for COSERO model calibration.
Supports single/multi-objective optimization, multiple subbasins, and automatic
zone-subbasin mapping via topology.txt. Requires the \code{rtop} package.
}
\details{
\strong{File handling:}
The original parameter file is backed up before optimization and automatically
restored after completion. Optimized parameters are saved to a new file:
\code{output/para_optimized_NB\{subbasins\}_\{metric\}_\{timestamp\}.txt}

\strong{Algorithm Details:}
SCE-UA is a global optimization strategy that combines the simplex procedure with
the concepts of controlled random search, competitive evolution, and complex shuffling.
The population is divided into \code{ngs} complexes, each evolving independently
via the Competitive Complex Evolution (CCE) algorithm (using Nelder-Mead simplex).
Periodically, the complexes are shuffled to share information, ensuring global
exploration and preventing the search from becoming trapped in local optima.
}
\examples{
\dontrun{
# SCE-UA requires rtop package
# install.packages("rtop")

# Example 1: Basic SCE-UA optimization
par_bounds <- create_optimization_bounds(
  parameters = c("BETA", "CTMAX", "LP"),
  lower = c(1, 2, 0.3),
  upper = c(6, 8, 1.0)
)

result <- optimize_cosero_sce(
  cosero_path = "D:/COSERO_project",
  par_bounds = par_bounds,
  target_subbasins = "001",
  metric = "NSE",
  maxn = 5000,
  defaults_settings = list(SPINUP = 365)
)

# Example 2: SCE-UA with custom convergence criteria
result_custom <- optimize_cosero_sce(
  cosero_path = "D:/COSERO_project",
  par_bounds = par_bounds,
  target_subbasins = "001",
  metric = "KGE",
  maxn = 10000,
  kstop = 5,      # Check convergence every 5 shuffles
  pcento = 0.001, # Stricter convergence threshold
  ngs = 3,        # More complexes for better exploration
  verbose = TRUE
)

# Compare DDS vs SCE-UA
result_dds <- optimize_cosero_dds(
  cosero_path = "D:/COSERO_project",
  par_bounds = par_bounds,
  target_subbasins = "001",
  metric = "NSE",
  max_iter = 2000
)

result_sce <- optimize_cosero_sce(
  cosero_path = "D:/COSERO_project",
  par_bounds = par_bounds,
  target_subbasins = "001",
  metric = "NSE",
  maxn = 5000
)

cat("DDS final NSE:", -result_dds$value, "\n")
cat("SCE final NSE:", -result_sce$value, "\n")
}
}
\references{
Duan, Q., Sorooshian, S., and Gupta, V. (1992). Effective and efficient global
optimization for conceptual rainfall-runoff models. Water Resources Research, 28(4), 1015-1031.
}
\seealso{
\code{\link{optimize_cosero_dds}} for DDS algorithm (faster, simpler),
\code{\link{create_optimization_bounds}} to define custom parameter bounds
}
