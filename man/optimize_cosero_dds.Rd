% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/cosero_optimize.R
\name{optimize_cosero_dds}
\alias{optimize_cosero_dds}
\title{Optimize COSERO Parameters with DDS Algorithm}
\usage{
optimize_cosero_dds(
  cosero_path,
  par_bounds,
  target_subbasins = "001",
  zones_to_modify = NULL,
  metric = "NSE",
  metric_weights = NULL,
  subbasin_weights = NULL,
  aggregation = "mean",
  defaults_settings = NULL,
  max_iter = 1000,
  r = 0.2,
  verbose = TRUE,
  read_final_outputs = TRUE,
  use_minimal_reading = TRUE
)
}
\arguments{
\item{cosero_path}{Character. Path to the COSERO project directory containing
\code{input/} and \code{output/} folders, and \code{COSERO.exe}.}

\item{par_bounds}{Data frame with parameter bounds. Create using
\code{\link{create_optimization_bounds}} for custom bounds or
\code{\link{load_parameter_bounds}} to use package defaults.
Required columns: parameter, min, max, default, modification_type.}

\item{target_subbasins}{Character vector. Subbasin IDs to calibrate for
(e.g., \code{"001"}, \code{c("001", "002")}, or \code{"all"}).
Controls both which zones are modified AND which subbasins are used
for metric calculation. Zone-subbasin mapping requires \code{topology.txt}
in output folder (generated by running COSERO at least once).}

\item{zones_to_modify}{Integer vector or NULL. Specific zone IDs to modify.
If NULL (default), zones are automatically determined from \code{target_subbasins}
using topology.txt. Use this for manual control, e.g., to optimize only
certain elevation bands or land use types.}

\item{metric}{Character vector. Performance metric(s) to optimize.
Options: \code{"NSE"} (default), \code{"KGE"}, \code{"lnNSE"}, \code{"rNSE"},
\code{"RMSE"}, \code{"PBIAS"}, \code{"VE"}.
For multi-objective, provide vector: \code{c("NSE", "KGE")}.}

\item{metric_weights}{Numeric vector or NULL. Weights for combining multiple
metrics (must sum to 1). Required when \code{metric} has length greater than 1.
Example: \code{c(0.6, 0.4)} for 0.6 NSE plus 0.4 KGE.}

\item{subbasin_weights}{Numeric vector or NULL. Weights for aggregating metrics
across subbasins. Required when \code{aggregation = "weighted"}.
Must have same length as \code{target_subbasins} and sum to 1.}

\item{aggregation}{Character. Method to aggregate metrics across multiple subbasins.
Options: \code{"mean"} (default), \code{"weighted"} (requires subbasin_weights),
\code{"min"} (worst subbasin), \code{"product"}.}

\item{defaults_settings}{Named list. COSERO configuration settings including
\code{STARTDATE}, \code{ENDDATE}, \code{SPINUP}, \code{OUTPUTTYPE}, \code{PARAFILE}.}

\item{max_iter}{Integer. Maximum number of DDS iterations.
Recommended: 50-100 (quick test), 500-1000 (standard), 2000-5000 (production).}

\item{r}{Numeric. DDS perturbation factor controlling neighborhood size.
Default 0.2 works well for most cases. Range: 0.1 (more local) to 0.3 (more global).}

\item{verbose}{Logical. If TRUE (default), prints progress bar and messages.}

\item{read_final_outputs}{Logical. If TRUE (default), runs COSERO once more
with optimal parameters and returns full output data.}

\item{use_minimal_reading}{Logical. If TRUE (default), only reads statistics.txt
and COSERO.runoff during optimization for faster I/O.}
}
\value{
A list containing:
\itemize{
\item \code{par}: Numeric vector of optimal parameter values
\item \code{value}: Best objective value (negative of metric, since DDS minimizes)
\item \code{history}: Data frame with columns: iteration, objective (for plotting convergence)
\item \code{par_bounds}: Input par_bounds with added \code{optimal_value} column
\item \code{runtime_seconds}: Total optimization time in seconds
\item \code{final_run}: COSERO run result with optimal parameters (if read_final_outputs=TRUE)
\item \code{optimized_par_file}: Path to the saved optimized parameter file
\item \code{target_subbasins}: Subbasins used for calibration
\item \code{zones_to_modify}: Zone IDs that were modified
\item \code{metric}: Metric(s) used
\item \code{algorithm}: "DDS"
}
}
\description{
Dynamically Dimensioned Search (DDS) optimization for COSERO model calibration.
Supports single/multi-objective optimization, multiple subbasins, and automatic
zone-subbasin mapping via topology.txt.
}
\details{
\strong{File handling:}
The original parameter file is backed up before optimization and automatically
restored after completion. Optimized parameters are saved to a new file:
\code{output/para_optimized_NB\{subbasins\}_\{metric\}_\{timestamp\}.txt}

\strong{Zone-subbasin mapping:}
Requires \code{topology.txt} in the output folder, which contains NZ (zone) and
NB (subbasin) columns. This file is generated when COSERO runs. If not found,
all zones will be modified regardless of \code{target_subbasins}.

\strong{Algorithm Details:}
DDS is a single-solution heuristic that scales the search dimension based on the
remaining computational budget. The algorithm starts by modifying all parameters
(global search) and linearly decreases the probability of perturbing any individual
parameter as the iteration count approaches \code{max_iter} (local search).
New candidate solutions are generated by perturbing the current best parameters
with a standard normal random variable scaled by the factor \code{r}.
The solution is updated only if the objective function value improves (greedy acceptance).
This dynamic adjustment of the search dimension allows DDS to converge rapidly
to good solutions in high-dimensional parameter spaces without requiring the extensive
sampling of population-based methods.
}
\examples{
\dontrun{
# Example 1: Basic single-objective optimization
par_bounds <- create_optimization_bounds(
  parameters = c("BETA", "CTMAX"),
  lower = c(1, 2),
  upper = c(6, 8)
)

result <- optimize_cosero_dds(
  cosero_path = "D:/COSERO_project",
  par_bounds = par_bounds,
  target_subbasins = "001",
  metric = "NSE",
  defaults_settings = list(SPINUP = 365),
  max_iter = 1000
)

# View results
print(result$par_bounds)
plot_cosero_optimization(result)

# Example 2: Multi-objective optimization (NSE + KGE)
result_multi <- optimize_cosero_dds(
  cosero_path = "D:/COSERO_project",
  par_bounds = par_bounds,
  target_subbasins = "001",
  metric = c("NSE", "KGE"),
  metric_weights = c(0.6, 0.4),
  max_iter = 2000
)

# Example 3: Multiple subbasins with weighted aggregation
result_multi_basin <- optimize_cosero_dds(
  cosero_path = "D:/COSERO_project",
  par_bounds = par_bounds,
  target_subbasins = c("001", "002", "003"),
  metric = "NSE",
  aggregation = "weighted",
  subbasin_weights = c(0.5, 0.3, 0.2),  # Weight by area/importance
  max_iter = 1500
)

# Example 4: Optimize only specific zones
result_zones <- optimize_cosero_dds(
  cosero_path = "D:/COSERO_project",
  par_bounds = par_bounds,
  zones_to_modify = c(1, 2, 5),  # Only modify zones 1, 2, and 5
  target_subbasins = "001",
  metric = "KGE",
  max_iter = 1000
)

# Example 5: Complete workflow with export
# Define parameters
par_bounds <- create_optimization_bounds(
  parameters = c("BETA", "CTMAX", "LP", "FC"),
  lower = c(1, 2, 0.3, 100),
  upper = c(6, 8, 1.0, 500)
)

# Run optimization
result <- optimize_cosero_dds(
  cosero_path = "D:/COSERO_project",
  par_bounds = par_bounds,
  target_subbasins = "001",
  metric = "NSE",
  defaults_settings = list(
    SPINUP = 365,
    OUTPUTTYPE = 1
  ),
  max_iter = 2000,
  verbose = TRUE
)

# Visualize and export
plot_cosero_optimization(result)
export_cosero_optimization(result, "D:/optimization_results")

# Access optimal parameters
optimal_params <- result$par_bounds[, c("parameter", "optimal_value")]
print(optimal_params)
}
}
\references{
Tolson, B.A. and Shoemaker, C.A. (2007). Dynamically dimensioned search algorithm
for computationally efficient watershed model calibration. Water Resources Research, 43(1).
}
\seealso{
\code{\link{optimize_cosero_sce}} for SCE-UA algorithm (more robust, slower),
\code{\link{create_optimization_bounds}} to define custom parameter bounds,
\code{\link{load_parameter_bounds}} to load predefined bounds from CSV,
\code{\link{plot_cosero_optimization}} to visualize convergence history,
\code{\link{export_cosero_optimization}} to export results to CSV files
}
